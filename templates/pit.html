{% extends "base.html" %}


{% block title %}
    PIT
{% endblock %}

{% block extra_head %}
    <!-- Alpine Plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>

    <!-- Alpine Core -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %}


{% block body %}
    <h3>
        –ö–∞—Ä—Ç–∏ —â–æ –∑–∞—Ä–∞–∑ –Ω–∞ –ø—ñ—Ç—ñ

    </h3>

    <table class="karts-on-pit"
           x-data="pitQueue"
           x-init="loadBadgesAndAccents()"
           @queue-add.window="addToQueue"
           @queue-reset.window="resetQueue">
        <thead>
        <th class="kart-number-cell">#</th>
        <th class="pilot-name-nowrap">Pilot</th>
        <th>Best</th>
        <th>Avg</th>
        <th class="kart-control"></th>
        </thead>

        <template x-for="kart in queue">
            <tbody>
            <tr class="best-stint" :style="{'background-color': kartsInfo[kart].color}">
                <td rowspan="2" class="kart-number-cell">
                        <a class="kart-number"
                              :href="'http://localhost:8000/kart/' + kart"
                              :style="getAccent(kart, accents)"
                              x-html="getBadge(kart, badges)">
                            <span></span>
                        </a>
                </td>
                <td class="pilot-name-nowrap" x-text="kartsInfo[kart].best_stint.pilot || '–ø—É—Å—Ç–æ'"></td>
                <td x-text="lapTimeOrEmpty(kartsInfo[kart].best_stint.best)"></td>
                <td x-text="lapTimeOrEmpty(kartsInfo[kart].best_stint.average)"></td>
                <td rowspan="2" class="kart-control" @click="switchColor(kart)">üîò</td>
            </tr>
            <tr class="last-stint" :style="{'background-color': kartsInfo[kart].color}">
                <td class="pilot-name-nowrap" x-text="kartsInfo[kart].last_stint.pilot || '–ø—É—Å—Ç–æ'"></td>
                <td x-text="lapTimeOrEmpty(kartsInfo[kart].last_stint.best)"></td>
                <td x-text="lapTimeOrEmpty(kartsInfo[kart].last_stint.average)"></td>
            </tr>
            </tbody>
        </template>

    </table>

    <div>
        <button
            style="width: 100%"
            onclick="document.getElementById('add-to-queue-dialog').showModal()">
            –î–æ–¥–∞—Ç–∏ –∫–∞—Ä—Ç –≤ —á–µ—Ä–≥—É
        </button>
        <br>
        <button
            style="width: 100%"
            onclick="confirm('–¢–æ—á–Ω–æ —Å–∫–∏–Ω—É—Ç–∏ –≤—Å–µ –∑ –ø—ñ—Ç–∞?') ? resetQueue() : null">
            –°–∫–∏–Ω—É—Ç–∏ –≤—Å–µ
        </button>
    </div>


    <dialog id="add-to-queue-dialog" >
        <header>–î–æ–¥–∞—Ç–∏ –∫–∞—Ä—Ç –≤ —á–µ—Ä–≥—É</header>
        <menu x-data>
            {% for kart in range(1, 11) %}
                <button class="available-kart" @click="requestAddToQueue({{ kart }})">{{ kart }}</button>
            {% endfor %}
            <hr>
            {% for kart in range(11, 21) %}
                <button class="available-kart" @click="requestAddToQueue({{ kart }})">{{ kart }}</button>
            {% endfor %}
            <hr>
            {% for kart in [21, 22, 33, 44, 69, 88] %}
                <button class="available-kart" @click="requestAddToQueue({{ kart }})">{{ kart }}</button>
            {% endfor %}
            <hr>
            <div x-data="{customKartNumber: 1}">
                <input
                        type="number" min="1" max="100"
                        x-model="customKartNumber" style="display: inline; margin-left: 0.5em; width: 5em;">
                <br>
                <button @click="requestAddToQueue(customKartNumber)" style="margin-left: 0.5em;">–ö–∞—Å—Ç–æ–º–Ω–∏–π –∫–∞—Ä—Ç</button>
            </div>
            <hr>

        </menu>
    </dialog>

{% endblock %}


{% block extra_js %}
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('pitQueue', () => ({
                queue: Alpine.$persist([]),
                kartsInfo: Alpine.$persist({}),
                badges: {},
                accents: {},

                addToQueue(event) {
                    console.log("Received new event, add to queue", event)
                    this.queue.push(event.detail.number)
                    this.kartsInfo[event.detail.number] = {...event.detail, color: nextColor()}
                },

                resetQueue() {
                    console.log('Reset queue')
                    // No need to drop this, it will be overriden when needed
                    // this.kartsInfo = {};
                    this.queue = [];
                },

                switchColor(kart_number) {
                    console.log('Switching color for', kart_number)
                    this.kartsInfo[kart_number].color = nextColor(this.kartsInfo[kart_number].color)
                },

                loadBadgesAndAccents() {
                    let component = this; // TODO: this is ugly
                    fetch("{{ url('get-karts-user-settings') }}")
                    .then(response => {
                        if (response.ok)
                            return response.json()
                        else
                            throw new Error('Cannot retrieve user settings', {cause: err})
                    })
                    .then(data => {
                        console.log('Received user settings', data);
                        component.badges = data.badges;
                        component.accents = data.accents;
                    })
                }
            }))
        })

        function requestAddToQueue(kart_number) {
            document.getElementById('add-to-queue-dialog').close()
            fetch("{{ url('get-pit-karts-stats') }}?kart=" + kart_number)
                .then(response => {
                    if (response.ok)
                        return response.json()
                    else
                        throw new Error('Cannot retrieve kart info', {cause: err})
                })
                .then(kart_info => dispatchEvent(new CustomEvent('queue-add', {detail: kart_info})))
                .catch(error => alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –∫–∞—Ä—Ç—É " + kart_number))
        }

        function resetQueue() {
            dispatchEvent(new CustomEvent('queue-reset'))
        }

        function nextColor(color) {
            switch (color) {
                case "white":
                    return "#ffeb94"  // yellow
                case "#ffeb94":
                    return "#ff9494"  // red
                case "#ff9494":
                    return "#a5a5a5"  // gray
                case "#a5a5a5":
                    return "white"
                default:
                    return "white"
            }
        }

        function getBadge(kart, badges) {
            const badge = badges[kart];
            if (badge === undefined)
                return kart
            else
                return kart + `<img class="badge ${badge}" src="/static/badges/${badge}.svg">`
        }

        function getAccent(kart, accents) {
            const accent = accents[kart];
            if (accent !== undefined)
                return "background-color: " + accent
        }

        function lapTimeOrEmpty(value) {
            return typeof value == 'number' ? value.toFixed(2) : '-';
        }

    </script>


{% endblock %}