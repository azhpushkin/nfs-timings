{% extends "base.html" %}


{% block title %}
    PIT
{% endblock %}

{% block extra_head %}
{% endblock %}


{% block body %}
<main id="app"></main>
{% endblock %}


{% block extra_js %}
<script type="module">
  import { h, text, app } from "https://unpkg.com/hyperapp"

  const href = (url, params) => window.location.origin + "/" + url + "?" + new URLSearchParams(params)


  const processKartResponse = (state, kart_info) => ({
      ...state,
      karts: state.karts.concat({...kart_info, color: "white"})
  })

  const addKartsToQueue = (state, kart_number) => [
      state,
      dispatch => {
        console.log("Requesting", kart_number);
        fetch(href("get-pit-karts-stats", {kart: kart_number}))
            .then(response => response.json())
            .then(kart_info => dispatch(processKartResponse, kart_info))
      }
  ]
  const nextColor = (color) => {
      switch (color) {
          case "white": return "yellow"
          case "yellow": return "red"
          case "red": return "gray"
          case "gray": return "white"
      }
  }


  const switchKartColor = (state, target_number) => {
      const index = state.karts.findIndex(({number}) => target_number === number)
      console.log(state)
      const new_kart = {...state.karts[index], color: nextColor(state.karts[index].color)};
      return {...state, karts: [...state.karts.slice(0, index), new_kart, ...state.karts.slice(index+1)]}

  }

  const kartsOnPit = (karts) => {
      console.log(karts);
      return karts.map(({number, last_stint, best_stint, color}) => [

          // Do not return kart number for second line due to rowspan
          h(
              "tr",
              {class: "best-stint " + color},
              Object.keys(best_stint).length !== 0 ? kartLine(number, best_stint) : emptyLine(number)
          ),
          h(
              "tr",
              {class: "last-stint " + color},
              (
                Object.keys(last_stint).length !== 0 ? kartLine(number, last_stint) : emptyLine(number)
            ).slice(1, 4)
          ),

      ]).flat()
  }

  const onPitLineHead = () => [
      h("th", {class: "kart-number-cell"}, text("#")),
      h("th", {class: "pilot-name-nowrap"}, text("Pilot")),
      h("th", {}, text("Best")),
      h("th", {}, text("Avg")),
      h("th", {class: "kart-control"}, text(""))
  ]
  const emptyLine = (number) => [
      h("td", {rowspan: 2, class: "kart-number-cell"}, h("a", {href: href("kart/"+number), class: "kart-number"}, text(number))),
      h("td", {class: "pilot-name-nowrap"}, text('пусто')),
      h("td", {}, text("-")),
      h("td", {}, text("-")),
      h("td", {rowspan: 2, class: "kart-control", onclick: [switchKartColor, number]}, text(String.fromCodePoint("0x1F518")))
  ]

  const kartLine = (number, stint_info) => [
      h("td", {rowspan: 2, class: "kart-number-cell"}, h("a", {href: href("kart/"+number), class: "kart-number"}, text(number))),
      h("td", {class: "pilot-name-nowrap"}, text(stint_info.pilot)),
      h("td", {}, text(stint_info.best.toFixed(2))),
      h("td", {}, text(stint_info.average.toFixed(2))),
      h("td", {rowspan: 2, class: "kart-control", onclick: [switchKartColor, number]}, text(String.fromCodePoint("0x1F518")))
  ]

  console.log(localStorage);
  const kartButton = (number) => h(
      "button",
      {class: "available-kart", onclick: [addKartsToQueue, number]},
      text(number)
  );
  const kartButtons = () => h(
      "div",
      {class: "available-karts-picker"},
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(kartButton)
            .concat(h("hr", {}))
            .concat([11, 12, 13, 14, 15, 16, 17, 18, 19, 20].map(kartButton))
            .concat(h("hr", {}))
            .concat([ 21, 22, 33, 44, 69].map(kartButton))
  );

  const resetAll =  state => {
      const areYouSure = confirm("Точно скинути все з піта?")
            console.log("RESET!", areYouSure)
      if (areYouSure)
          return {karts: []};
      else return state;
  }

  const saveToLocal = state => {
      console.log("SAVED!!")
      localStorage.setItem("karts", JSON.stringify(state.karts))
  }
  const saveToLocalSubscriber = (dispatch, options) => {
      console.log("saveToLocalSubscriber called", options)
      saveToLocal(options.state);
      return () => {}
  }

  const loadFromStorage = () => {
      const karts = JSON.parse(localStorage.getItem("karts"))
      console.log("Loading from storage", karts);
      return karts || [];
  }

  app({
    init: { karts: loadFromStorage()},
    view: ({ karts }) =>
      h("main", {}, [
          h("h3", {onclick: [addKartsToQueue, 2]}, text("Карти що зараз на піті")),
          h("table", {class: "karts-on-pit"}, [
              h("thead", {}, onPitLineHead()),
              h("tbody", {}, kartsOnPit(karts)),

          ]),
          h("br", {}),
          h("h3", {}, text("Додати карт в чергу")),
          kartButtons(),
          h("button", {class: 'reset-all', onclick: resetAll}, text('Скинути все!'))
      ]),
    node: document.getElementById("app"),
    subscriptions: state => [
        [saveToLocalSubscriber, {state}]
    ]
  })


</script>


{% endblock %}